\label{xmark-queries-mongodb}
\begin{enumerate}[label=Q\arabic*.]
	\item %1
	\begin{lstlisting}[language=JSON,   basicstyle=\scriptsize]
		db.people.find({_id:"person0"},{_id:0,"name":1});
	\end{lstlisting}
	
	\item %2
	\begin{lstlisting}[language=JSON,  basicstyle=\scriptsize]
	db.open_auctions.aggregate([
		{$project:{_id:1,bidder:"$bidder"}},
		{ $unwind: "$bidder"},
		{$group:{_id:"$_id",increase:{$first:"$bidder.increase"}}},
		{$sort:{_id:1}},
		{ $unwind: "$increase"},
		{$project:{_id:0,increase:1}}
	])
	\end{lstlisting}
	
    \item %3
	\begin{lstlisting}[language=JSON,   basicstyle=\scriptsize]
	   db.open_auctions.aggregate([
		{ $unwind: "$bidder"},
		{$group:{_id:"$_id",first:{$first:"$bidder.increase"},last:{$last:"$bidder.increase"}}},
		{$unwind:"$first"},
		{$unwind:"$last"},
		{$project:{_id:1,first:1,last:1,diff:{$gte:["$last",{$multiply:["$first",2]}]}}},
		{$match:{diff:true}},
		{$sort:{_id:1}},
		{$project:{_id:0,increase:{first:"$first",last:"$last"}}}
	   ])
	\end{lstlisting}
	
	
    \item %4
	\begin{lstlisting}[language=JSON,   basicstyle=\scriptsize]
	   []
	\end{lstlisting}
	
	
    \item %5
	\begin{lstlisting}[language=JSON,   basicstyle=\scriptsize]
	   db.closed_auctions.find({price:{$gte:40}}).count()
	\end{lstlisting}
	
    \item %6
	\begin{lstlisting}[language=JSON,   basicstyle=\scriptsize]
	   db.regions.find().count()
	\end{lstlisting}
	
	
    \item %7
	\begin{lstlisting}[language=JSON,   basicstyle=\scriptsize]
	   []
	\end{lstlisting}
	
	
    \item %8
	\begin{lstlisting}[language=JSON,   basicstyle=\scriptsize]
	   function q8() {
        	var ids = new Array();
        	var name = new Array();
        	var closed = new Array();
        	var i=0;
        	db.people.find({},{name:1}).forEach(function(people){
        		ids[i] = people._id;
        		name[ids[i]] = people.name;
        		//closed[ids[i]] = {name:people.name,count:0};
        		i++;
        	});
        	var closed_auc = db.closed_auctions.aggregate([
        		{$project:{_id:1,person:"$buyer.person"}},
        		//{$match:{person:{$in:["person12124","person12883"]}}},
        		{$match:{person:{$in:ids}}},
        		{$group:{_id:"$person",count:{$sum:1}}},
        		{$sort:{count:-1}},
        		{$project:{person:"$_id",count:1,_id:0}}
        	]);
        	if(closed_auc) {
        		var i=0
        		while(closed_auc.hasNext()){
        			var auc = closed_auc.next();
        			var id = auc.person;
        			closed[i] = {"name":name[id],"count":auc.count}
        			name[id] = 0;
        			i++;
        			//printjson(name.indexOf(id));
        		}
        		
        	}/**/
        	var len = closed.length ;
        	var j = 0;
        	for(var i=0; i < ids.length; i++) {
        		if(name[ids[i]] !== 0) {
        		//printjson(i);
        		closed[len+j]	= {"name":name[ids[i]],"count":0};
        		j++;
        		}
        	}
        	//printjson("Execution Time" + end-start);
        	return closed;
        	
        }
	\end{lstlisting}
	
	
    \item %9
	\begin{lstlisting}[language=JSON,   basicstyle=\scriptsize]
	   
	\end{lstlisting}
	
	
    \item %10
	\begin{lstlisting}[language=JSON,   basicstyle=\scriptsize]
	//helper function for Q10.
    var getProfileByCategory = function(catId){
    		var prof = new Array();
    		var i = 0;
    		db.people.find(
    		{"profile.interest":{$exists:true},"profile.interest":{"$elemMatch": {category:catId}}},
    		{name:1, profile:1,address:1}
    		).forEach(function(p){
    			if(!p.address) {
    				p.address = {};
    			}
    			var c = function (value){return ((value) && (typeof value !== "undefined")) ? value : "";}; 
    			prof[i] = {
                          personne: {
                            statistiques: {
                              sexe: c(p.profile.gender),
                              age: c(p.profile.gender),
                              education: c(p.profile.education),
                              revenu: c(p.profile.income)
                            },
                            coordonnees: {
                              nom: p.name,
                              rue: (c(p.address)&&c(p.address.street)),
                              ville: c(p.address.city),
                              pays: c(p.address.country),
                              reseau: {
                                courrier: c(p.emailaddress),
                                pagePerso: c(p.homepage)
                              }
                            },
                            cartePaiement: c(p.creditcard)
                          }
                        }
                            			
    			})
    		return prof;
    		};
    		
    		
	   function q10() {
        	var debugId = "person3"
        	var ids = new Array();
        	var i = 0;
        	var allcategories = new Array();
        	db.people.aggregate([
        	{$match:{"profile.interest":{$exists:true}}},
        	{$project:{_id:1, interest:"$profile.interest"}},
        	{$unwind:"$interest"},
        	{$group:{_id:"$interest.category"}},
        	{$project:{_id:0, category:"$_id"}}
        	]).forEach(function(people){
        		var catId = people.category;
        		ids[i] = {categorie:{id:catId,profile:getProfileByCategory(catId)}}
        		i++;
        	});
        	return ids;
        }
	\end{lstlisting}
	
	
    \item %11
	\begin{lstlisting}[language=JSON,   basicstyle=\scriptsize]
	  function q11() {
    	var start = new Date().getTime();
    	var debugId = "person3"
    	var ids = new Array();
    	var open_auc = function(initial){
    		return db.open_auctions.find({initial:{$lt:initial}},{_id:1}).count();
    	}
    	
    	var i=0;
    	db.people.find({},{_id:1, name:1,"profile.income":1}).forEach(function(people){
    		var income = ((people.profile) && people.profile.income)? people.profile.income/5000:0;
    		ids[i] = {item:{name: people.name,id:people._id,count:open_auc(income)}};
    		i++;
    	});
    	return ids;
        }
	\end{lstlisting}
	
	
    \item %12
	\begin{lstlisting}[language=JSON,   basicstyle=\scriptsize]
	   function q12() {
    	var debugId = "person3"
    	var ids = new Array();
    	var open_auc = function(initial){
    		return db.open_auctions.find({initial:{$lt:initial}},{_id:1}).count();
    	}
    	var i=0;
    	db.people.find({"profile.income":{$exists:true}, "profile.income":{$gt:50000}},{_id:1, name:1,"profile.income":1}).forEach(function(people){
    		var income = ((people.profile) && people.profile.income)? people.profile.income/5000:0;
    		ids[i] = {item:{name: people.name,id:people._id,count:open_auc(income)}};
    		i++;
    	});
    	return ids;

    }
	\end{lstlisting}
	
	\item %13
	\begin{lstlisting}[language=JSON,   basicstyle=\scriptsize]
	    db.regions.find(
		{regions:"australia"},
		{_id:0,name:1,description:1}
        )
	\end{lstlisting}
	
    \item %14
	\begin{lstlisting}[language=JSON,   basicstyle=\scriptsize]
	  db.regions.aggregate([
		{$match:{$text:{$search:"gold"}}},
		{$group:{_id:"$_id"}},
		{$group:{_id:null,count:{$sum:1}}},
		{$project:{_id:0,count:1}}
	])
	\end{lstlisting}
	
    \item %15
	\begin{lstlisting}[language=JSON,   basicstyle=\scriptsize]
	 db.closed_auctions.aggregate([
		{$project:{_id:1,parlist:"$annotation.description.parlist"}},
		{ $unwind: "$parlist"},
		{ $unwind: "$parlist.listitem.parlist"},
		{$project:{_id:1,text:"$parlist.listitem.parlist.listitem.text"}},
		{$match:{$or:[{"text.emph.keyword":{$exists:true}},{"text.emph.keyword.childtext":{$exists:true}},{"text.emph.keyword.child":{$exists:true}}]}},
		{$project:{_id:0,text:"$text.emph.keyword"}}
	])
	\end{lstlisting}
	
    \item %16
	\begin{lstlisting}[language=JSON,   basicstyle=\scriptsize]
	  db.closed_auctions.aggregate([
		{$project:{_id:1,parlist:"$annotation.description.parlist",person:"$seller.person"}},
		{ $unwind: "$parlist"},
		{ $unwind: "$parlist.listitem.parlist"},
		{$project:{_id:1,text:"$parlist.listitem.parlist.listitem.text",person:1}},
		{$match:{"text.emph.keyword":{$exists:true}}},
		{$project:{_id:0,"person.id":"$person"}}
	])
	\end{lstlisting}	

    \item %17
	\begin{lstlisting}[language=JSON,   basicstyle=\scriptsize]
	  db.people.find({homepage:{$exists:false}},{_id:0,person:"$name"})
	])
	\end{lstlisting}	

    \item %18
	\begin{lstlisting}[language=JSON,   basicstyle=\scriptsize]
	  db.open_auctions.aggregate([{$match:{reserve:{$exists:true}}},
		{$project:{_id:0,reserve:{$multiply:["$reserve",2.20371]}}}])
	\end{lstlisting}	

    \item %19
	\begin{lstlisting}[language=JSON,   basicstyle=\scriptsize]
	  db.regions.aggregate([{$sort:{location:1}},
		{$project:{_id:0,"item.name":"$name","item.location":"$location"}}])
	\end{lstlisting}	
    
    \item %20
	\begin{lstlisting}[language=JSON,   basicstyle=\scriptsize]
	  db.people.aggregate([
		{$project:{_id:1,p:"$profile.income"}},
		{$project:{_id:1,con:
			{$cond:[
			  {$gt:["$p",100000]},"preferred",
			  {$cond:[{ $and: [{$lt:["$p", 100000] }, {$gte:["$p", 30000] }] },"standard",
		{$cond:[{$and:[{$lt:["$p",30000]},{$gt:["$p",0]}]},"challange","na"]}
		]}
		]}
		}},
		{$group:{_id:"$con",sum:{$sum:1}}},
		{$project:{_id:1,sum:1}}])
	\end{lstlisting}
\end{enumerate}
\noindent\makebox[\linewidth]{\rule{\paperwidth}{0.4pt}}
\begin{lstlisting}[language=JSON,   basicstyle=\scriptsize, label=mongodb-xmark-index, caption=Secondary indexes in MongoDB's XMark data]
	  db.open_auctions.ensureIndex({
		initial:1
	})
	db.open_auctions.ensureIndex({
		bidder:1
	})
	db.open_auctions.ensureIndex({
		"bidder.increase":1
	})
	
	db.regions.ensureIndex({
		name:1,
		location:1
	})
	db.regions.ensureIndex({
		regions:1
	})
	db.regions.ensureIndex({
		location:1
	})
	db.regions.ensureIndex([
                   { "$**": "text" },
                   { name: "TextIndex" }
                         ])
	db.people.ensureIndex({
		"people.interest":1
	})

	db.closed_auctions.ensureIndex({
		"buyer.person":1
	});
	db.closed_auctions.ensureIndex({price:1})
	\end{lstlisting}
